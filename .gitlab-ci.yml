stages:
  - build
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

build_core:
  stage: build
  script:
    - yarn install --frozen-lockfile
    - yarn workspace @TRPI/core build
  artifacts:
    paths:
      - BUILD/core/dist

build_backend:
  stage: build
  needs: ["build_core"]
  script:
    - yarn install --frozen-lockfile
    - yarn workspace @TRPI/backend build
  artifacts:
    paths:
      - BUILD/backend/dist

build_frontend:
  stage: build
  needs: ["build_core"]
  script:
    - yarn install --frozen-lockfile
    - yarn workspace @TRPI/frontend build
  artifacts:
    paths:
      - BUILD/frontend/dist

deploy_backend:
  stage: deploy
  only:
    - dev
  needs: ["build_backend"]
  script:
    - sudo -u ubuntu screen -S backend -X quit || true
    - sudo -u ubuntu screen -dmS backend
    - echo 'deploiement du backend pas disponible pour l'instant

deploy_frontend:
  stage: deploy
  only:
    - dev
  needs: ["build_frontend"]
  script:
    - sudo -u ubuntu screen -S frontend -X quit || true
    - sudo -u ubuntu screen -dmS frontend
    - sudo -u ubuntu screen -S frontend -X stuff "cd BUILD/frontend/dist; npx serve -l 1000$(printf '\r')"
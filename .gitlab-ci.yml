
---
stages:
  - ssh-prepare
  - server
  - front
  - deploy

ssh-prepare:
  stage: ssh-prepare
  script:
    - echo 'ssh-connection'
    - apt update
    - apt upgrade -y
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo '' > ~/.ssh/config
    - cp artifacts/config ~/.ssh/config
    - cat ~/.ssh/config
    - echo $SSH_PRIVATE_KEY > ~/private.pem
    - chmod 600 ~/private.pem
    - apt -y install openssh-client
    - apt install -y -qq openvpn





deploy:
  stage: deploy
  script:
    - echo 'deploy test'
  only:
    - master
server:
  stage: server
  script:
    - ssh vmProjetIntegrateurgrp0-1
    - echo 'server build'
  only:
    changes:
      - apps/backend/**/*
  dependencies:
    - ssh-prepare

front:
  stage: front
  script:
    - ssh vmProjetIntegrateurgrp0-1
    - echo 'front build'
  only:
    changes:
      - apps/frontend/**/*
  dependencies:
    - ssh-prepare

stages:
  - build
  - test

build_docker_image:
  stage: build
  image: docker:20.10
  services:
    - docker:20.10-dind
  script:
    - docker build -t my_monorepo_image .
    - docker save my_monorepo_image -o my_monorepo_image.tar
  artifacts:
    paths:
      - my_monorepo_image.tar

test_core:
  stage: test
  image: docker:20.10
  services:
    - docker:20.10-dind
  script:
    - docker load -i my_monorepo_image.tar
    - docker run my_monorepo_image bash -c "cd core && yarn test"




# deploy:
#   stage: deploy
#   script:
#     - echo 'deploy test'
#   only:
#     - master
# server:
#   stage: server
#   script:
#     - ssh vmProjetIntegrateurgrp0-1
#     - echo 'server build'
#   only:
#     changes:
#       - apps/backend/**/*
#   dependencies:
#     - ssh-prepare

# front:
#   stage: front
#   script:
#     - ssh vmProjetIntegrateurgrp0-1
#     - echo 'front build'
#   only:
#     changes:
#       - apps/frontend/**/*
#   dependencies:
#     - ssh-prepare